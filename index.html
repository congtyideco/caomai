<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Danh Mục Thuốc - Hệ Thống Thông Minh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #1e88e5;
            --secondary-color: #0d47a1;
            --success-color: #43a047;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --light-bg: #f8f9fa;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 15px;
        }
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table th {
            background-color: #e3f2fd;
            color: #1565c0;
            border-bottom: 2px solid #bbdefb;
            font-size: 12px;
            padding: 8px 4px;
            position: relative;
            user-select: none;
        }
        .table td {
            padding: 6px 4px;
            font-size: 12px;
            vertical-align: middle;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-success {
            background-color: var(--success-color);
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-danger {
            background-color: var(--danger-color);
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .btn-warning {
            background-color: var(--warning-color);
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
            color: white;
        }
        .btn-info {
            background-color: #17a2b8;
            border: none;
            border-radius: 5px;
            padding: 6px 10px;
            font-size: 12px;
            color: white;
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
        }
        .status-available {
            color: var(--success-color);
            font-weight: bold;
        }
        .status-out-of-stock {
            color: var(--danger-color);
            font-weight: bold;
        }
        .status-discontinued {
            color: var(--warning-color);
            font-weight: bold;
        }
        .status-pending {
            color: #9e9e9e;
            font-weight: bold;
        }
        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid #ced4da;
            font-size: 12px;
            padding: 4px 6px;
        }
        /* Màu sắc cho sản lượng */
        .quantity-high {
            color: #d32f2f !important;
            font-weight: bold;
            font-size: 13px;
        }
        .quantity-medium {
            color: #1976d2 !important;
            font-weight: bold;
            font-size: 13px;
        }
        .quantity-low {
            color: #7b1fa2 !important;
            font-weight: bold;
            font-size: 13px;
        }
        .quantity-very-low {
            color: #000000 !important;
            font-weight: bold;
            font-size: 13px;
        }
        .status-dropdown {
            min-width: 120px;
        }
        .file-upload {
            background-color: #e3f2fd;
            border: 2px dashed #90caf9;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }
        .file-upload:hover {
            background-color: #bbdefb;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .new-row {
            background-color: #e8f5e9;
        }
        .footer {
            margin-top: 20px;
            padding: 15px 0;
            background-color: #e3f2fd;
            text-align: center;
            color: #546e7a;
            font-size: 12px;
        }
        .alert-section {
            margin-bottom: 15px;
        }
        .alert-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .alert-warning {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning-color);
        }
        .alert-danger {
            background-color: #f8d7da;
            border-left: 4px solid var(--danger-color);
        }
        .alert-info {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        .low-stock {
            background-color: #fff3cd !important;
        }
        .out-of-stock {
            background-color: #f8d7da !important;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-icon {
            position: relative;
        }
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-card {
            flex: 1;
            min-width: calc(50% - 8px);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card.total {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
        }
        .stat-card.available {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
        }
        .stat-card.low-stock {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        .stat-card.out-of-stock {
            background: linear-gradient(135deg, #F44336, #C62828);
        }
        .stat-card h3 {
            margin: 0;
            font-size: 16px;
        }
        .stat-card p {
            margin: 3px 0 0;
            font-size: 11px;
        }
        .import-section {
            background-color: #e8f5e9;
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
        }
        .btn-group-vertical {
            width: 100%;
        }
        .btn-group-vertical .btn {
            margin-bottom: 4px;
            text-align: left;
            font-size: 11px;
            padding: 6px 8px;
        }
        
        /* Màu sắc cho mã và tên sản phẩm theo sản lượng */
        .high-quantity-code {
            color: #d32f2f !important;
            font-weight: bold;
        }
        .high-quantity-name {
            color: #d32f2f !important;
            font-weight: bold;
        }
        .medium-quantity-code {
            color: #1976d2 !important;
            font-weight: bold;
        }
        .medium-quantity-name {
            color: #1976d2 !important;
            font-weight: bold;
        }
        .low-quantity-code {
            color: #7b1fa2 !important;
            font-weight: bold;
        }
        .low-quantity-name {
            color: #7b1fa2 !important;
            font-weight: bold;
        }
        .very-low-quantity-code {
            color: #000000 !important;
            font-weight: bold;
        }
        .very-low-quantity-name {
            color: #000000 !important;
            font-weight: bold;
        }
        
        /* Style cho trường ngày giao */
        .delivery-date-input {
            min-width: 120px;
        }
        .delivery-date-overdue {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: bold;
        }
        .delivery-date-today {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
            font-weight: bold;
        }
        .delivery-date-future {
            background-color: #e3f2fd !important;
            color: #1565c0 !important;
        }
        
        /* Style cho checkbox và hàng được chọn */
        .selected-row {
            background-color: #e3f2fd !important;
        }
        .checkbox-cell {
            width: 30px;
            text-align: center;
        }
        .selection-controls {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }
        
        /* Style cho cột Hạn dụng */
        .expiry-date-input {
            min-width: 120px;
        }
        .expiry-date-overdue {
            background-color: #ffebee !important;
            color: #c62828 !important;
            font-weight: bold;
        }
        .expiry-date-close {
            background-color: #fff3cd !important;
            color: #f57c00 !important;
            font-weight: bold;
        }
        .expiry-date-future {
            background-color: #e8f5e9 !important;
            color: #2e7d32 !important;
        }
        
        /* Style cho tính năng kéo giãn cột */
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background-color: transparent;
            cursor: col-resize;
            z-index: 10;
        }
        .resize-handle:hover, .resize-handle.active {
            background-color: #1565c0;
        }
        .resize-line {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: #1565c0;
            z-index: 100;
            pointer-events: none;
            display: none;
        }
        
        /* Responsive cho mobile */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 11px;
            }
            .table th, .table td {
                padding: 4px 2px;
            }
            .btn {
                font-size: 11px;
                padding: 4px 6px;
            }
            .card-body {
                padding: 10px;
            }
            .header h1 {
                font-size: 18px;
            }
            .header p {
                font-size: 12px;
            }
            .delivery-date-input {
                min-width: 100px;
                font-size: 10px;
            }
            .expiry-date-input {
                min-width: 100px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-stats {
                flex-direction: column;
            }
            .stat-card {
                min-width: 100%;
            }
            
            /* Tối ưu hóa chiều rộng cột trên mobile (576px) */

            .table td:nth-child(3), /* Mã SP */
            .table th:nth-child(3) {
                max-width: 60px; /* Thu hẹp Mã SP */
                width: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .table td:nth-child(4), /* Tên sản phẩm - Cột cần mở rộng */
            .table th:nth-child(4) {
                max-width: 100%; 
                width: auto;
                white-space: normal; /* Cho phép tên sản phẩm hiển thị đủ */
            }
            
            .table td:nth-child(5), /* SL đặt dự kiến/tháng */
            .table th:nth-child(5) {
                max-width: 80px; /* Thu hẹp SL đặt */
                width: 80px;
            }
            
            .table td:nth-child(6), /* Trạng thái */
            .table th:nth-child(6) {
                max-width: 80px; /* Thu hẹp Trạng thái */
                width: 80px;
            }

            .table td:nth-child(7), /* Ngày dự kiến giao */
            .table th:nth-child(7) {
                max-width: 90px; /* Thu hẹp Ngày giao */
                width: 90px;
            }

            .table td:nth-child(8), /* Hạn dụng */
            .table th:nth-child(8) {
                max-width: 90px; /* Thu hẹp Hạn dụng */
                width: 90px;
            }

            .table td:nth-child(9), /* Thao tác */
            .table th:nth-child(9) {
                max-width: 50px; /* Thu hẹp Thao tác */
                width: 50px;
            }
            /* End Tối ưu hóa chiều rộng cột */
            
            .delivery-date-input {
                min-width: 80px;
            }
            .expiry-date-input {
                min-width: 80px;
            }
            .table th {
                white-space: nowrap; 
            }
        }
        
        /* Compact mode cho bảng */
        .compact-table {
            font-size: 11px;
        }
        .compact-table .form-control,
        .compact-table .form-select {
            font-size: 11px;
            padding: 2px 4px;
            height: 28px;
        }

        /* Style cho modal xóa toàn bộ */
        .modal-header.bg-danger {
            background: linear-gradient(135deg, var(--danger-color), #c62828) !important;
        }
    </style>
</head>
<body>
    <div class="header mb-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h4 mb-1"><i class="fas fa-pills me-2"></i>BẢNG CHIA SẼ HOẠT ĐỘNG CUNG ỨNG THUỐC CHO IDECO</h1>
                    <p class="mb-0 small"> Hãy cùng nhau cập nhật -chia sẽ để 2 doanh nghiệp chúng ta bán tốt hơn - thành công hơn với lời cám ơn các bạn Cao Mai</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button class="btn btn-light btn-sm" id="exportBtn">
                            <i class="fas fa-file-export me-1"></i> Xuất Excel
                        </button>
                        <button class="btn btn-light btn-sm notification-icon" id="alertBtn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge d-none" id="alertCount">0</span>
                        </button>
                        <button class="btn btn-danger btn-sm" id="deleteAllBtn">
                            <i class="fas fa-trash-alt me-1"></i> Xóa toàn bộ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-stats">
            <div class="stat-card total">
                <h3 id="totalMedicines">0</h3>
                <p>Tổng số thuốc</p>
            </div>
            <div class="stat-card available">
                <h3 id="availableMedicines">0</h3>
                <p>Còn hàng</p>
            </div>
            <div class="stat-card low-stock">
                <h3 id="lowStockMedicines">0</h3>
                <p>Sắp hết hàng</p>
            </div>
            <div class="stat-card out-of-stock">
                <h3 id="outOfStockMedicines">0</h3>
                <p>Hết hàng</p>
            </div>
        </div>

        <div class="alert-section" id="alertSection">
            <div id="alertContainer">
                </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-2">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <h6 class="card-title mb-1"><i class="fas fa-file-import me-1"></i>Nhập dữ liệu</h6>
                                <div class="file-upload mb-2" id="fileUpload">
                                    <i class="fas fa-cloud-upload-alt fa-lg mb-1 text-primary"></i>
                                    <p class="mb-0 small">File Excel danh mục thuốc</p>
                                    <input type="file" id="excelFile" accept=".xlsx, .xls" class="d-none">
                                </div>
                                <div id="fileInfo" class="text-muted small"></div>
                                
                                <div class="import-section">
                                    <h6 class="mb-1"><i class="fas fa-chart-line me-1"></i>Nhập sản lượng dự kiến</h6>
                                    <div class="file-upload mb-1" id="quantityFileUpload">
                                        <i class="fas fa-file-excel fa-lg mb-1 text-success"></i>
                                        <p class="mb-0 small">File Excel sản lượng cuối kỳ</p>
                                        <input type="file" id="quantityExcelFile" accept=".xlsx, .xls" class="d-none">
                                    </div>
                                    <div class="btn-group-vertical">
                                        <button class="btn btn-outline-primary btn-sm" id="loadQuantity2Btn">
                                            <i class="fas fa-calculator me-1"></i> DL 2tháng 
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" id="loadQuantity3Btn">
                                            <i class="fas fa-calculator me-1"></i> DL 3tháng
                                        </button>
                                    </div>
                                    <div id="quantityFileInfo" class="text-muted small mt-1"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="card-title mb-1"><i class="fas fa-search me-1"></i>Tìm kiếm & Thao tác</h6>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" placeholder="Tìm theo tên hoặc mã..." id="searchInput">
                                    <button class="btn btn-outline-secondary" type="button">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-success btn-sm flex-fill" id="addRowBtn">
                                        <i class="fas fa-plus me-1"></i> Thêm mới
                                    </button>
                                    <button class="btn btn-primary btn-sm flex-fill" id="saveAllBtn">
                                        <i class="fas fa-save me-1"></i> Lưu tất cả
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="selection-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                        <label class="form-check-label small" for="selectAllCheckbox">
                            Chọn tất cả (<span id="selectedCount">0</span> đã chọn)
                        </label>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-warning" id="filterSelectedBtn">
                            <i class="fas fa-filter me-1"></i> Lọc sản phẩm đã chọn
                        </button>
                        <button class="btn btn-info" id="refreshBtn">
                            <i class="fas fa-redo me-1"></i> Làm mới
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover compact-table" id="medicineTable">
                            <thead>
                                <tr>
                                    <th width="30" class="checkbox-cell">
                                        <input type="checkbox" class="form-check-input" id="mainCheckbox">
                                    </th>
                                    <th width="40">STT</th>
                                    <th width="80">Mã SP</th>
<th width="180">Tên sản phẩm</th>  <th width="100">SL đặt dự kiến/tháng</th>
<th width="80">Trạng thái</th>
<th width="100">Ngày dự kiến giao</th>
<th width="100">Hạn dụng</th>
                                    <th width="80">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="medicineTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2 align-items-center">
                    <div class="text-muted small" id="rowCount">Hiển thị 0 mục</div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div class="footer mt-3">
        <div class="container">
            <p class="mb-0">CÁM ƠN SỰ HỢP TÁC CÁC BẠN CÔNG TY DP CAO MAI NHE!</p>
        </div>
    </div>

    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="messageModalLabel">Thông báo</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2" id="messageModalBody">
                    </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertConfigModal" tabindex="-1" aria-labelledby="alertConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header py-2">
                    <h6 class="modal-title" id="alertConfigModalLabel">Cấu hình cảnh báo</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2">
                    <div class="mb-2">
                        <label for="lowStockThreshold" class="form-label small">Ngưỡng cảnh báo sắp hết hàng</label>
                        <input type="number" class="form-control form-control-sm" id="lowStockThreshold" value="10" min="1">
                        <div class="form-text small">Số lượng tồn kho dưới ngưỡng này sẽ được cảnh báo sắp hết hàng</div>
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary btn-sm" id="saveAlertConfig">Lưu cấu hình</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteAllModal" tabindex="-1" aria-labelledby="deleteAllModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header py-2 bg-danger text-white">
                    <h6 class="modal-title" id="deleteAllModalLabel"><i class="fas fa-exclamation-triangle me-1"></i>Cảnh báo</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-3">
                    <div class="alert alert-danger mb-2">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        <strong>Hành động này không thể hoàn tác!</strong>
                    </div>
                    <p class="mb-1">Bạn sắp xóa <strong class="text-danger">TOÀN BỘ</strong> dữ liệu danh mục thuốc.</p>
                    <p class="mb-0 small text-muted">Tất cả thông tin thuốc, sản lượng và trạng thái sẽ bị xóa vĩnh viễn.</p>
                    
                    <div class="mt-3">
                        <label for="confirmDeleteText" class="form-label small">Nhập "XÓA TOÀN BỘ" để xác nhận:</label>
                        <input type="text" class="form-control form-control-sm" id="confirmDeleteText" placeholder="XÓA TOÀN BỘ">
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteAllBtn" disabled>
                        <i class="fas fa-trash-alt me-1"></i> Xóa toàn bộ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD4g_O1TwLYo49-yazwtro75G6GDpF2bR8",
            authDomain: "dlthuoc.firebaseapp.com",
            projectId: "dlthuoc",
            storageBucket: "dlthuoc.firebasestorage.app",
            messagingSenderId: "814425739687",
            appId: "1:814425739687:web:aaca9d2c54f5cf2034a682",
            measurementId: "G-PTCMG6PZ4Q"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Biến toàn cục
        let medicines = [];
        let nextId = 1;
        let lowStockThreshold = 10;
        let quantityData = [];
        let selectedMedicines = new Set();
        let isFilteringSelected = false;
        let currentDisplayData = [];
        let isResizing = false;
        let currentResizeColumn = null;
        let startX = 0;
        let startWidth = 0;

        // Hàm khởi tạo
        function init() {
            loadAlertConfig();
            loadMedicinesFromFirebase();
            setupEventListeners();
            setupColumnResizing(); // Thiết lập tính năng kéo giãn cột
        }

        // Hàm thiết lập tính năng kéo giãn cột
        function setupColumnResizing() {
            const table = document.getElementById('medicineTable');
            const headers = table.querySelectorAll('th');
            const resizeLine = document.createElement('div');
            resizeLine.className = 'resize-line';
            document.body.appendChild(resizeLine);

            headers.forEach((header, index) => {
                // Bỏ qua cột STT, checkbox, và các cột không muốn cho resize
                if (index === 0 || index === 1) return;
                
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                header.appendChild(handle);
                
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    currentResizeColumn = header;
                    startX = e.pageX;
                    startWidth = header.offsetWidth;
                    
                    // Hiển thị đường kẻ resize
                    resizeLine.style.left = (header.getBoundingClientRect().left + header.offsetWidth) + 'px';
                    resizeLine.style.display = 'block';
                    
                    document.body.style.userSelect = 'none'; // Ngăn chọn văn bản
                    document.body.style.cursor = 'col-resize'; // Đổi con trỏ
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing || !currentResizeColumn) return;
                
                const deltaX = e.pageX - startX;
                const newWidth = Math.max(50, startWidth + deltaX); // Đảm bảo cột không quá nhỏ
                
                // Cập nhật đường kẻ resize
                resizeLine.style.left = (currentResizeColumn.getBoundingClientRect().left + newWidth) + 'px';
                
                // Cập nhật chiều rộng cột
                currentResizeColumn.style.width = newWidth + 'px';
                
                // Cập nhật tất cả các ô trong cột
                const columnIndex = Array.from(currentResizeColumn.parentNode.children).indexOf(currentResizeColumn);
                const rows = table.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    if (cells[columnIndex]) {
                        cells[columnIndex].style.width = newWidth + 'px';
                    }
                });
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    currentResizeColumn = null;
                    resizeLine.style.display = 'none';
                    document.body.style.userSelect = '';
                    document.body.style.cursor = '';
                }
            });
        }

        // Hàm xác định màu sắc cho hạn dụng
        function getExpiryDateColorClass(expiryDate) {
            if (!expiryDate) return '';
            
            const today = new Date();
            const expiry = new Date(expiryDate);
            
            const diffTime = expiry.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'expiry-date-overdue';
            if (diffDays <= 30) return 'expiry-date-close'; // Cảnh báo nếu còn 30 ngày hoặc ít hơn
            return 'expiry-date-future';
        }

        // Hàm tải cấu hình cảnh báo từ Firebase
        function loadAlertConfig() {
            database.ref('alertConfig').on('value', (snapshot) => {
                const config = snapshot.val();
                if (config && config.lowStockThreshold) {
                    lowStockThreshold = config.lowStockThreshold;
                    document.getElementById('lowStockThreshold').value = lowStockThreshold;
                }
            });
        }

        // Hàm lưu cấu hình cảnh báo lên Firebase
        function saveAlertConfig() {
            const newThreshold = parseInt(document.getElementById('lowStockThreshold').value);
            if (newThreshold && newThreshold > 0) {
                lowStockThreshold = newThreshold;
                database.ref('alertConfig').set({
                    lowStockThreshold: lowStockThreshold
                }).then(() => {
                    showMessage('Đã lưu cấu hình cảnh báo thành công!');
                    checkAlerts();
                }).catch((error) => {
                    showMessage('Lỗi khi lưu cấu hình: ' + error.message);
                });
            }
        }

        // Hàm tải dữ liệu từ Firebase
        function loadMedicinesFromFirebase() {
            database.ref('medicines').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    medicines = Object.values(data);
                    nextId = Math.max(...medicines.map(m => m.id)) + 1;
                } else {
                    medicines = [];
                    nextId = 1;
                }
                currentDisplayData = medicines;
                renderTable();
                updateDashboardStats();
                checkAlerts();
                updateSelectedCount();
            });
        }

        // Hàm lưu dữ liệu lên Firebase
        function saveMedicinesToFirebase() {
            const medicinesObj = {};
            medicines.forEach(medicine => {
                medicinesObj[medicine.id] = medicine;
            });
            
            database.ref('medicines').set(medicinesObj)
                .then(() => {
                    console.log('Dữ liệu đã được lưu lên Firebase');
                })
                .catch((error) => {
                    console.error('Lỗi khi lưu dữ liệu: ', error);
                    showMessage('Lỗi khi lưu dữ liệu: ' + error.message);
                });
        }

        // Hàm xác định màu sắc cho sản lượng và trả về class tương ứng
        function getQuantityColorClass(quantity) {
            if (quantity > 300) return 'quantity-high';
            if (quantity >= 100) return 'quantity-medium';
            if (quantity >= 50) return 'quantity-low';
            return 'quantity-very-low';
        }

        // Hàm xác định màu sắc cho mã và tên sản phẩm
        function getCodeNameColorClass(quantity) {
            if (quantity > 300) return {code: 'high-quantity-code', name: 'high-quantity-name'};
            if (quantity >= 100) return {code: 'medium-quantity-code', name: 'medium-quantity-name'};
            if (quantity >= 50) return {code: 'low-quantity-code', name: 'low-quantity-name'};
            return {code: 'very-low-quantity-code', name: 'very-low-quantity-name'};
        }

        // Hàm xác định màu sắc cho ngày giao
        function getDeliveryDateColorClass(deliveryDate) {
            if (!deliveryDate) return '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delivery = new Date(deliveryDate);
            delivery.setHours(0, 0, 0, 0);
            
            if (delivery < today) {
                return 'delivery-date-overdue';
            } else if (delivery.getTime() === today.getTime()) {
                return 'delivery-date-today';
            } else {
                return 'delivery-date-future';
            }
        }

        // Hàm định dạng ngày hiển thị
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Hàm hiển thị dữ liệu
        function renderTable(data = null) {
            const displayData = data || currentDisplayData;
            const tableBody = document.getElementById('medicineTableBody');
            tableBody.innerHTML = '';
            
            displayData.forEach((medicine, index) => {
                const isSelected = selectedMedicines.has(medicine.id);
                const row = document.createElement('tr');
                
                if (isSelected) {
                    row.classList.add('selected-row');
                }
                
                // Thêm class cảnh báo nếu số lượng thấp
                if (medicine.monthlyOrder !== undefined && medicine.monthlyOrder < lowStockThreshold && medicine.monthlyOrder > 0) {
                    row.classList.add('low-stock');
                } else if (medicine.monthlyOrder === 0) {
                    row.classList.add('out-of-stock');
                }
                
                if (medicine.isNew) {
                    row.classList.add('new-row');
                }
                
                // Xác định class cho trạng thái
                let statusClass = '';
                let statusText = '';
                switch(medicine.status) {
                    case 'available':
                        statusClass = 'status-available';
                        statusText = 'Còn hàng ở CM';
                        break;
                    case 'out-of-stock':
                        statusClass = 'status-out-of-stock';
                        statusText = 'Hết hàng';
                        break;
                    case 'discontinued':
                        statusClass = 'status-discontinued';
                        statusText = 'Đứt hàng';
                        break;
                    case 'pending':
                        statusClass = 'status-pending';
                        statusText = 'Chờ CM đặt hàng';
                        break;
                }

                // Xác định màu sắc cho sản lượng
                const monthlyOrder = medicine.monthlyOrder || 0;
                const quantityColorClass = getQuantityColorClass(monthlyOrder);
                
                // Xác định màu sắc cho mã và tên sản phẩm
                const codeNameColorClasses = getCodeNameColorClass(monthlyOrder);
                
                // Xác định màu sắc cho ngày giao
                const deliveryDateColorClass = getDeliveryDateColorClass(medicine.deliveryDate);
                
                // Xác định màu sắc cho hạn dụng
                const expiryDateColorClass = getExpiryDateColorClass(medicine.expiryDate);
                
                row.innerHTML = `
                    <td class="checkbox-cell">
                        <input type="checkbox" class="form-check-input row-checkbox" data-id="${medicine.id}" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${index + 1}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm ${codeNameColorClasses.code}" value="${medicine.code || ''}" data-field="code" data-id="${medicine.id}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm ${codeNameColorClasses.name}" value="${medicine.name || ''}" data-field="name" data-id="${medicine.id}">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm ${quantityColorClass}" value="${monthlyOrder}" data-field="monthlyOrder" data-id="${medicine.id}" min="0" readonly>
                    </td>
                    <td>
                        <select class="form-select form-select-sm status-dropdown ${statusClass}" data-field="status" data-id="${medicine.id}">
                            <option value="available" ${medicine.status === 'available' ? 'selected' : ''}>Còn hàng ở CM</option>
                            <option value="out-of-stock" ${medicine.status === 'out-of-stock' ? 'selected' : ''}>Hết hàng</option>
                            <option value="discontinued" ${medicine.status === 'discontinued' ? 'selected' : ''}>Không còn bán</option>
                            <option value="pending" ${medicine.status === 'pending' ? 'selected' : ''}>Chờ CM đặt hàng</option>
                        </select>
                    </td>
                    <td>
                        <input type="date" class="form-control form-control-sm delivery-date-input ${deliveryDateColorClass}" 
                               value="${medicine.deliveryDate || ''}" 
                               data-field="deliveryDate" 
                               data-id="${medicine.id}"
                               title="${medicine.deliveryDate ? formatDisplayDate(medicine.deliveryDate) : 'Chưa có ngày giao'}">
                    </td>
                    <td>
                        <input type="month" class="form-control form-control-sm expiry-date-input ${expiryDateColorClass}" 
                               value="${medicine.expiryDate || ''}" 
                               data-field="expiryDate" 
                               data-id="${medicine.id}">
                    </td>
                    <td class="action-buttons">
                        <button class="btn btn-success btn-sm save-btn" data-id="${medicine.id}" title="Lưu">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm delete-btn" data-id="${medicine.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.getElementById('rowCount').textContent = `Hiển thị ${displayData.length} mục`;
            addRowEventListeners();
            updateMainCheckbox();
        }

        // Hàm thêm sự kiện cho các hàng
        function addRowEventListeners() {
            // Sự kiện cho checkbox từng dòng
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const row = this.closest('tr');
                    
                    if (this.checked) {
                        selectedMedicines.add(id);
                        row.classList.add('selected-row');
                    } else {
                        selectedMedicines.delete(id);
                        row.classList.remove('selected-row');
                    }
                    updateSelectedCount();
                    updateMainCheckbox();
                });
            });

            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    saveRow(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteRow(id);
                });
            });
            
            // Thêm sự kiện tự động lưu khi thay đổi trạng thái
            document.querySelectorAll('select[data-field="status"]').forEach(select => {
                select.addEventListener('change', function() {
                    this.classList.remove('status-available', 'status-out-of-stock', 'status-discontinued', 'status-pending');
                    switch(this.value) {
                        case 'available': this.classList.add('status-available'); break;
                        case 'out-of-stock': this.classList.add('status-out-of-stock'); break;
                        case 'discontinued': this.classList.add('status-discontinued'); break;
                        case 'pending': this.classList.add('status-pending'); break;
                    }
                    
                    // Tự động lưu khi thay đổi trạng thái
                    const id = parseInt(this.getAttribute('data-id'));
                    saveRow(id);
                });
            });
            
            // Thêm sự kiện tự động lưu khi thay đổi ngày giao
            document.querySelectorAll('input[data-field="deliveryDate"]').forEach(input => {
                input.addEventListener('change', function() {
                    // Cập nhật màu sắc khi thay đổi ngày
                    this.classList.remove('delivery-date-overdue', 'delivery-date-today', 'delivery-date-future');
                    const newColorClass = getDeliveryDateColorClass(this.value);
                    if (newColorClass) {
                        this.classList.add(newColorClass);
                    }
                    
                    // Tự động lưu khi thay đổi ngày giao
                    const id = parseInt(this.getAttribute('data-id'));
                    saveRow(id);
                });
            });
            
            // Thêm sự kiện tự động lưu khi thay đổi hạn dụng
            document.querySelectorAll('input[data-field="expiryDate"]').forEach(input => {
                input.addEventListener('change', function() {
                    // Cập nhật màu sắc khi thay đổi hạn dụng
                    this.classList.remove('expiry-date-overdue', 'expiry-date-close', 'expiry-date-future');
                    const newColorClass = getExpiryDateColorClass(this.value);
                    if (newColorClass) {
                        this.classList.add(newColorClass);
                    }
                    
                    // Tự động lưu khi thay đổi hạn dụng
                    const id = parseInt(this.getAttribute('data-id'));
                    saveRow(id);
                });
            });
        }

        // Hàm cập nhật checkbox chọn tất cả
        function updateMainCheckbox() {
            const mainCheckbox = document.getElementById('mainCheckbox');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            
            if (allCheckboxes.length === 0) {
                mainCheckbox.checked = false;
                mainCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
                return;
            }
            
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            
            if (checkedCount === 0) {
                mainCheckbox.checked = false;
                mainCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedCount === allCheckboxes.length) {
                mainCheckbox.checked = true;
                mainCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                mainCheckbox.checked = false;
                mainCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }

        // Hàm cập nhật số lượng đã chọn
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedMedicines.size;
        }

        // Hàm chọn/bỏ chọn tất cả
        function toggleSelectAll() {
            const mainCheckbox = document.getElementById('mainCheckbox');
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            const currentData = isFilteringSelected ? currentDisplayData : medicines;
            
            if (mainCheckbox.checked || document.getElementById('selectAllCheckbox').checked) {
                // Chọn tất cả các hàng đang hiển thị
                currentData.forEach(med => {
                    selectedMedicines.add(med.id);
                });
            } else {
                // Bỏ chọn tất cả các hàng đang hiển thị
                currentData.forEach(med => {
                    selectedMedicines.delete(med.id);
                });
            }
            
            renderTable();
            updateSelectedCount();
        }

        // Hàm lọc sản phẩm đã chọn
        function filterSelectedProducts() {
            if (selectedMedicines.size === 0) {
                showMessage('Vui lòng chọn ít nhất một sản phẩm để lọc!');
                return;
            }
            
            isFilteringSelected = true;
            currentDisplayData = medicines.filter(med => selectedMedicines.has(med.id));
            renderTable(currentDisplayData);
            showMessage(`Đang hiển thị ${currentDisplayData.length} sản phẩm đã chọn`);
        }

        // Hàm làm mới dữ liệu
        function refreshData() {
            isFilteringSelected = false;
            currentDisplayData = medicines;
            renderTable();
            showMessage('Đã làm mới dữ liệu');
        }

        // Hàm lưu một hàng
        function saveRow(id) {
            const rowData = {};
            const inputs = document.querySelectorAll(`[data-id="${id}"]`);
            
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                let value = input.value;
                
                if (field === 'price' || field === 'quantity' || field === 'monthlyOrder') {
                    value = parseInt(value) || 0;
                }
                
                rowData[field] = value;
            });
            
            const index = medicines.findIndex(med => med.id === id);
            if (index !== -1) {
                medicines[index] = { ...medicines[index], ...rowData };
                
                if (medicines[index].isNew) {
                    delete medicines[index].isNew;
                }
                
                saveMedicinesToFirebase();
                showMessage('Đã lưu thông tin thuốc thành công!');
            }
        }

        // Hàm xóa một hàng
        function deleteRow(id) {
            if (confirm('Bạn có chắc chắn muốn xóa thuốc này không?')) {
                medicines = medicines.filter(med => med.id !== id);
                selectedMedicines.delete(id);
                currentDisplayData = currentDisplayData.filter(med => med.id !== id);
                saveMedicinesToFirebase();
                showMessage('Đã xóa thuốc thành công!');
            }
        }

        // Hàm thêm hàng mới
        function addNewRow() {
            const newMedicine = {
                id: nextId++,
                code: "",
                name: "",
                price: 0,
                quantity: 0,
                monthlyOrder: 0,
                status: "pending",
                deliveryDate: "",
                expiryDate: "",
                isNew: true
            };
            
            medicines.unshift(newMedicine);
            currentDisplayData = medicines;
            renderTable();
            showMessage('Đã thêm hàng mới. Vui lòng nhập thông tin và lưu.');
        }

        // Hàm hiển thị thông báo
        function showMessage(message) {
            const modalBody = document.getElementById('messageModalBody');
            modalBody.textContent = message;
            
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            modal.show();
        }

        // Hàm kiểm tra cảnh báo
        function checkAlerts() {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '';
            
            let alertCount = 0;
            
            // Kiểm tra thuốc sắp hết hàng
            const lowStockMedicines = medicines.filter(med => 
                med.monthlyOrder !== undefined && med.monthlyOrder < lowStockThreshold && med.monthlyOrder > 0
            );
            
            if (lowStockMedicines.length > 0) {
                alertCount += lowStockMedicines.length;
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item alert-warning';
                alertDiv.innerHTML = `
                    <span><i class="fas fa-exclamation-triangle me-1"></i> ${lowStockMedicines.length} thuốc sắp hết hàng</span>
                    <button class="btn btn-sm btn-outline-warning" onclick="filterLowStock()">Xem</button>
                `;
                alertContainer.appendChild(alertDiv);
            }
            
            // Kiểm tra thuốc hết hàng
            const outOfStockMedicines = medicines.filter(med => med.monthlyOrder === 0);
            
            if (outOfStockMedicines.length > 0) {
                alertCount += outOfStockMedicines.length;
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item alert-danger';
                alertDiv.innerHTML = `
                    <span><i class="fas fa-times-circle me-1"></i> ${outOfStockMedicines.length} thuốc đã hết hàng</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="filterOutOfStock()">Xem</button>
                `;
                alertContainer.appendChild(alertDiv);
            }
            
            // Cập nhật badge thông báo
            const alertBadge = document.getElementById('alertCount');
            if (alertCount > 0) {
                alertBadge.textContent = alertCount;
                alertBadge.classList.remove('d-none');
            } else {
                alertBadge.classList.add('d-none');
            }
        }

        // Hàm lọc thuốc sắp hết hàng
        function filterLowStock() {
            const filtered = medicines.filter(med => 
                med.monthlyOrder !== undefined && med.monthlyOrder < lowStockThreshold && med.monthlyOrder > 0
            );
            currentDisplayData = filtered;
            renderTable();
        }

        // Hàm lọc thuốc hết hàng
        function filterOutOfStock() {
            const filtered = medicines.filter(med => med.monthlyOrder === 0);
            currentDisplayData = filtered;
            renderTable();
        }

        // Hàm cập nhật thống kê
        function updateDashboardStats() {
            const total = medicines.length;
            const available = medicines.filter(med => med.status === 'available').length;
            const lowStock = medicines.filter(med => 
                med.monthlyOrder !== undefined && med.monthlyOrder < lowStockThreshold && med.monthlyOrder > 0
            ).length;
            const outOfStock = medicines.filter(med => 
                med.monthlyOrder === 0
            ).length;
            
            document.getElementById('totalMedicines').textContent = total;
            document.getElementById('availableMedicines').textContent = available;
            document.getElementById('lowStockMedicines').textContent = lowStock;
            document.getElementById('outOfStockMedicines').textContent = outOfStock;
        }

        // Hàm xử lý file Excel
        function handleExcelFile(file, isQuantityFile = false) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Lấy sheet đầu tiên
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Chuyển đổi sheet thành JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (isQuantityFile) {
                        // Xử lý file sản lượng
                        processQuantityData(jsonData);
                    } else {
                        // Xử lý file danh mục thuốc
                        processMedicineData(jsonData);
                    }
                } catch (error) {
                    console.error('Lỗi khi xử lý file Excel:', error);
                    showMessage('Lỗi khi xử lý file Excel: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showMessage('Lỗi khi đọc file. Vui lòng thử lại.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Hàm xử lý dữ liệu sản lượng từ Excel
        function processQuantityData(data) {
            quantityData = [];
            
            // Bỏ qua hàng tiêu đề (nếu có)
            const startRow = data[0] && data[0].some(cell => cell && cell.toString().toLowerCase().includes('mã')) ? 1 : 0;
            
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                if (row && row.length >= 2) {
                    const code = row[0] ? row[0].toString().trim() : '';
                    const quantity = row[1] ? parseFloat(row[1]) : 0;
                    
                    if (code) {
                        quantityData.push({
                            code: code,
                            quantity: quantity
                        });
                    }
                }
            }
            
            document.getElementById('quantityFileInfo').textContent = `Đã tải ${quantityData.length} mã sản phẩm từ file sản lượng`;
            showMessage(`Đã tải ${quantityData.length} mã sản phẩm từ file sản lượng`);
        }

        // Hàm xử lý dữ liệu thuốc từ Excel
        function processMedicineData(data) {
            const newMedicines = [];
            
            console.log('Dữ liệu file Excel:', data);
            
            // Bỏ qua hàng tiêu đề (nếu có) - file của bạn có header ở hàng đầu
            const startRow = 1;
            
            for (let i = startRow; i < data.length; i++) {
                const row = data[i];
                console.log(`Hàng ${i}:`, row);
                
                if (row && row.length >= 3) {
                    // File của bạn có: Cột A (index 0): STT, Cột B (index 1): Mã SP, Cột C (index 2): Tên sản phẩm
                    const code = row[1] ? row[1].toString().trim() : '';
                    const name = row[2] ? row[2].toString().trim() : '';
                    
                    console.log(`Mã: "${code}", Tên: "${name}"`);
                    
                    if (code && name && code !== 'Tổng') {
                        // Kiểm tra xem mã đã tồn tại chưa
                        const exists = medicines.some(med => med.code === code);
                        if (!exists) {
                            newMedicines.push({
                                id: nextId++,
                                code: code,
                                name: name,
                                price: 0,
                                quantity: 0,
                                monthlyOrder: 0,
                                status: "pending",
                                deliveryDate: "",
                                expiryDate: "",
                                deliveryAbility: "Có thể giao sau"
                            });
                        }
                    }
                }
            }
            
            console.log('Số thuốc mới:', newMedicines.length);
            
            if (newMedicines.length > 0) {
                // Thêm thuốc mới vào đầu danh sách
                medicines = [...newMedicines, ...medicines];
                currentDisplayData = medicines;
                saveMedicinesToFirebase();
                showMessage(`Đã nhập ${newMedicines.length} thuốc mới từ file Excel`);
            } else {
                showMessage('Không tìm thấy dữ liệu thuốc mới hợp lệ trong file Excel hoặc tất cả mã đã tồn tại');
            }
        }

        // Hàm tải sản lượng với hệ số chia
        function loadQuantityWithDivider(divider) {
            if (quantityData.length === 0) {
                showMessage('Vui lòng tải file sản lượng trước!');
                return;
            }
            
            // Tạo bản sao của medicines để sắp xếp
            const sortedMedicines = [...medicines];
            
            // Cập nhật sản lượng dự kiến cho từng thuốc
            sortedMedicines.forEach(medicine => {
                const quantityItem = quantityData.find(item => item.code === medicine.code);
                if (quantityItem) {
                    medicine.monthlyOrder = Math.round(quantityItem.quantity / divider);
                } else {
                    medicine.monthlyOrder = 0;
                }
            });
            
            // Sắp xếp theo sản lượng giảm dần
            sortedMedicines.sort((a, b) => b.monthlyOrder - a.monthlyOrder);
            
            // Cập nhật danh sách chính
            medicines = sortedMedicines;
            currentDisplayData = medicines;
            
            // Lưu lên Firebase
            saveMedicinesToFirebase();
            
            showMessage(`Đã cập nhật sản lượng dự kiến (chia ${divider}) và sắp xếp theo sản lượng cao nhất`);
        }

        // Hàm xuất dữ liệu ra Excel
        function exportToExcel() {
            // Tạo workbook mới
            const wb = XLSX.utils.book_new();
            
            // Chuẩn bị dữ liệu
            const data = [
                ['Mã SP', 'Tên sản phẩm', 'SL đặt dự kiến/tháng', 'Trạng thái', 'Ngày dự kiến giao', 'Hạn dụng']
            ];
            
            medicines.forEach(medicine => {
                let statusText = '';
                switch(medicine.status) {
                    case 'available': statusText = 'Còn hàng'; break;
                    case 'out-of-stock': statusText = 'Hết hàng'; break;
                    case 'discontinued': statusText = 'Đứt hàng'; break;
                    case 'pending': statusText = 'Chưa về kho'; break;
                }
                
                data.push([
                    medicine.code,
                    medicine.name,
                    medicine.monthlyOrder || 0,
                    statusText,
                    medicine.deliveryDate ? formatDisplayDate(medicine.deliveryDate) : '',
                    medicine.expiryDate || ''
                ]);
            });
            
            // Tạo worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // Thêm worksheet vào workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Danh mục thuốc');
            
            // Xuất file
            XLSX.writeFile(wb, 'danh_muc_thuoc.xlsx');
        }

        // Hàm xóa toàn bộ dữ liệu
        function deleteAllData() {
            const confirmText = document.getElementById('confirmDeleteText').value;
            
            if (confirmText !== 'XÓA TOÀN BỘ') {
                showMessage('Vui lòng nhập chính xác "XÓA TOÀN BỘ" để xác nhận!');
                return;
            }
            
            // Hiển thị loading
            const confirmBtn = document.getElementById('confirmDeleteAllBtn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Đang xóa...';
            confirmBtn.disabled = true;
            
            // Xóa dữ liệu trên Firebase
            database.ref('medicines').remove()
                .then(() => {
                    // Reset local data
                    medicines = [];
                    nextId = 1;
                    selectedMedicines.clear();
                    isFilteringSelected = false;
                    currentDisplayData = [];
                    
                    // Cập nhật giao diện
                    renderTable();
                    updateDashboardStats();
                    checkAlerts();
                    updateSelectedCount();
                    
                    // Đóng modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteAllModal'));
                    modal.hide();
                    
                    // Reset nút
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    document.getElementById('confirmDeleteText').value = '';
                    
                    showMessage('Đã xóa toàn bộ dữ liệu thành công!');
                })
                .catch((error) => {
                    console.error('Lỗi khi xóa dữ liệu: ', error);
                    
                    // Reset nút
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    
                    showMessage('Lỗi khi xóa dữ liệu: ' + error.message);
                });
        }

        // Hàm mở modal xóa toàn bộ
        function openDeleteAllModal() {
            // Reset trường xác nhận
            document.getElementById('confirmDeleteText').value = '';
            document.getElementById('confirmDeleteAllBtn').disabled = true;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteAllModal'));
            modal.show();
        }

        // Hàm kiểm tra xác nhận xóa
        function checkDeleteConfirmation() {
            const confirmText = document.getElementById('confirmDeleteText').value;
            const confirmBtn = document.getElementById('confirmDeleteAllBtn');
            
            confirmBtn.disabled = confirmText !== 'XÓA TOÀN BỘ';
        }

        // Hàm thiết lập các sự kiện
        function setupEventListeners() {
            // Sự kiện cho file upload
            document.getElementById('fileUpload').addEventListener('click', function() {
                document.getElementById('excelFile').click();
            });
            
            document.getElementById('excelFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    document.getElementById('fileInfo').textContent = `File: ${file.name}`;
                    handleExcelFile(file, false);
                }
            });
            
            // Sự kiện cho file sản lượng
            document.getElementById('quantityFileUpload').addEventListener('click', function() {
                document.getElementById('quantityExcelFile').click();
            });
            
            document.getElementById('quantityExcelFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    document.getElementById('quantityFileInfo').textContent = `File: ${file.name}`;
                    handleExcelFile(file, true);
                }
            });
            
            // Sự kiện cho các nút
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            document.getElementById('saveAllBtn').addEventListener('click', function() {
                medicines.forEach(med => {
                    if (med.isNew) {
                        delete med.isNew;
                    }
                });
                saveMedicinesToFirebase();
                showMessage('Đã lưu tất cả thông tin thuốc!');
            });
            
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            document.getElementById('alertBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('alertConfigModal'));
                modal.show();
            });
            
            document.getElementById('saveAlertConfig').addEventListener('click', saveAlertConfig);
            
            // Sự kiện cho các nút tải sản lượng
            document.getElementById('loadQuantity2Btn').addEventListener('click', function() {
                loadQuantityWithDivider(2);
            });
            
            document.getElementById('loadQuantity3Btn').addEventListener('click', function() {
                loadQuantityWithDivider(3);
            });
            
            // Sự kiện tìm kiếm
            document.getElementById('searchInput').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm) {
                    const filteredMedicines = medicines.filter(med => 
                        med.code.toLowerCase().includes(searchTerm) || 
                        med.name.toLowerCase().includes(searchTerm)
                    );
                    currentDisplayData = filteredMedicines;
                    renderTable();
                } else {
                    currentDisplayData = medicines;
                    renderTable();
                }
            });

            // Sự kiện cho nút xóa toàn bộ
            document.getElementById('deleteAllBtn').addEventListener('click', openDeleteAllModal);

            // Sự kiện cho nút xác nhận xóa toàn bộ
            document.getElementById('confirmDeleteAllBtn').addEventListener('click', deleteAllData);

            // Sự kiện kiểm tra xác nhận xóa
            document.getElementById('confirmDeleteText').addEventListener('input', checkDeleteConfirmation);

            // Sự kiện cho phím Enter trong modal xóa
            document.getElementById('confirmDeleteText').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('confirmDeleteAllBtn').disabled) {
                    deleteAllData();
                }
            });

            // Sự kiện cho checkbox chọn tất cả
            document.getElementById('mainCheckbox').addEventListener('change', toggleSelectAll);
            document.getElementById('selectAllCheckbox').addEventListener('change', toggleSelectAll);

            // Sự kiện cho nút lọc sản phẩm đã chọn
            document.getElementById('filterSelectedBtn').addEventListener('click', filterSelectedProducts);

            // Sự kiện cho nút làm mới
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        }

        // Khởi chạy ứng dụng
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
